@page "/"
@using HydraulicGradient.Models
@using HydraulicGradient.Services
@inject GradientCalculationService CalculationService

<PageTitle>EPA Hydraulic Gradient Calculator</PageTitle>

<div class="container-fluid">
    <h1 class="text-primary mb-4">EPA On-line Tools for Site Assessment Calculation</h1>
    
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h3 class="card-title mb-0">Hydraulic Gradient -- Magnitude and Direction</h3>
        </div>
        <div class="card-body">
            <h4 class="text-success">Gradient Calculation</h4>
            <p>from fitting a plane to as many as thirty points</p>
            
            <div class="mathematical-explanation mb-3">
                <p>a x₁ + b y₁ + c = h₁</p>
                <p>a x₂ + b y₂ + c = h₂</p>
                <p>a x₃ + b y₃ + c = h₃</p>
                <p><strong>. . .</strong></p>
                <p>a x₃₀ + b y₃₀ + c = h₃₀</p>
                
                <p class="mt-3">
                    where (xᵢ,yᵢ) are the coordinates of the well and<br/>
                    hᵢ is the head<br/>
                    <br/>
                    i = 1,2,3, ... , 30<br/>
                    The coefficients a, b, and c are calculated by a least-squares fitting of the data to a plane<br/>
                    <br/>
                    The gradient is calculated from the square root of (a² + b²) and the angle from the arctangent of a/b or b/a depending on the quadrant
                </p>
            </div>
            
            <!-- Simple illustration using CSS -->
            <div class="gradient-illustration">
                <div class="coordinate-system">
                    <div class="axis y-axis"></div>
                    <div class="axis x-axis"></div>
                    <div class="axis-label y-label">Y (North)</div>
                    <div class="axis-label x-label">X (East)</div>
                    <div class="gradient-arrow"></div>
                    <div class="angle-indicator">θ</div>
                    <div class="wells">
                        <div class="well" style="top: 30%; left: 20%;"></div>
                        <div class="well" style="top: 60%; left: 40%;"></div>
                        <div class="well" style="top: 40%; left: 70%;"></div>
                        <div class="well" style="top: 80%; left: 30%;"></div>
                    </div>
                </div>
                <p class="text-center mt-2 small">
                    <em>Illustration showing coordinate directions and flow direction angle measurement</em>
                </p>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-danger text-white">
            <h4 class="card-title mb-0">Inputs</h4>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-3">
                    <button class="btn btn-outline-primary" @onclick="LoadExampleData1">Example Data Set 1</button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-primary" @onclick="LoadExampleData2">Example Data Set 2</button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-success" @onclick="Calculate">Calculate</button>
                    <button class="btn btn-secondary ml-2" @onclick="Clear">Clear</button>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="form-group">
                        <label>Site Name</label>
                        <input type="text" class="form-control" @bind="SiteName" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="text" class="form-control" @bind="Date" />
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label>&nbsp;</label><br/>
                        <button class="btn btn-outline-secondary" @onclick="SetCurrentDate">Current Date</button>
                    </div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Calculation basis</label>
                        <select class="form-control" @bind="UseHeadSquared">
                            <option value="false">Head</option>
                            <option value="true">Head Squared</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Coordinates</label>
                        <select class="form-control" @bind="CoordinateUnit">
                            <option value="ft">ft</option>
                            <option value="m">m</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Head Unit</label>
                        <select class="form-control" @bind="HeadUnit">
                            <option value="ft">ft</option>
                            <option value="m">m</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5>Data Points</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>I.D.</th>
                            <th>x-coordinate</th>
                            <th>y-coordinate</th>
                            <th>head (@HeadUnit)</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < DataPoints.Count; i++)
                        {
                            var index = i;
                            <tr>
                                <td>
                                    @(index + 1)) 
                                    <input type="text" class="form-control form-control-sm" style="width: 80px; display: inline-block;" 
                                           @bind="DataPoints[index].Id" />
                                </td>
                                <td>
                                    <input type="number" step="0.01" class="form-control form-control-sm" style="width: 100px;" 
                                           @bind="DataPoints[index].X" />
                                </td>
                                <td>
                                    <input type="number" step="0.01" class="form-control form-control-sm" style="width: 100px;" 
                                           @bind="DataPoints[index].Y" />
                                </td>
                                <td>
                                    <input type="number" step="0.01" class="form-control form-control-sm" style="width: 100px;" 
                                           @bind="DataPoints[index].Head" />
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    @if (Result != null)
    {
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="card-title mb-0">Results</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Number of Points Used in Calculation</label>
                            <input type="text" class="form-control" value="@Result.NumberOfPoints" readonly />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Max. Difference Between Head Values</label>
                            <input type="text" class="form-control" value="@Result.MaxHeadDifference.ToString("F4")" readonly />
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Gradient Magnitude (i)</label>
                            <input type="text" class="form-control" value="@Result.GradientMagnitude.ToString("F6")" readonly />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Flow direction as degrees from North (positive y axis)</label>
                            <input type="text" class="form-control" value="@Result.FlowDirection.ToString("F2")" readonly />
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Coefficient of Determination (R²)</label>
                            <input type="text" class="form-control" value="@Result.CoefficientOfDetermination.ToString("F6")" readonly />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<DataPoint> DataPoints = new();
    private GradientResult? Result;
    private string SiteName = "";
    private string Date = "";
    private bool UseHeadSquared = false;
    private string CoordinateUnit = "ft";
    private string HeadUnit = "ft";

    protected override void OnInitialized()
    {
        InitializeDataPoints();
        SetCurrentDate();
    }

    private void InitializeDataPoints()
    {
        DataPoints = Enumerable.Range(1, 30)
            .Select(i => new DataPoint())
            .ToList();
    }

    private void LoadExampleData1()
    {
        Clear();
        var exampleData = CalculationService.GetExampleDataSet1();
        for (int i = 0; i < exampleData.Count && i < DataPoints.Count; i++)
        {
            DataPoints[i] = exampleData[i];
        }
        SiteName = "Example Site 1";
        Calculate();
    }

    private void LoadExampleData2()
    {
        Clear();
        var exampleData = CalculationService.GetExampleDataSet2();
        for (int i = 0; i < exampleData.Count && i < DataPoints.Count; i++)
        {
            DataPoints[i] = exampleData[i];
        }
        SiteName = "Example Site 2";
        Calculate();
    }

    private void Calculate()
    {
        Result = CalculationService.CalculateGradient(DataPoints, UseHeadSquared);
    }

    private void Clear()
    {
        InitializeDataPoints();
        Result = null;
        SiteName = "";
    }

    private void SetCurrentDate()
    {
        Date = DateTime.Now.ToString("yyyy-MM-dd");
    }
}
